name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)

trigger:
  - none

pr:
  - none

parameters:
  - name: environmentName
    default: "dev"

  - name: keyVaultArmSvcConnectionName
    default: "Symphony-KV"

  - name: keyVaultName
    default: "kv-symphony-env"

variables:
  - name: agentImage
    value: "ubuntu-latest"

  - name: workDir
    value: "$(System.DefaultWorkingDirectory)/IAC/Terraform/terraform"

  - name: runBackupState
    value: true

  - name: goVersion
    value: "1.18.1"

  - name: terraformVersion
    value: "1.1.7"

pool:
  vmImage: $(agentImage)

jobs:
  - template: ./template.terraform.validate.yml
    parameters:
      goVersion: "$(goVersion)"
      terraformVersion: "$(terraformVersion)"
      keyVaultArmSvcConnectionName: "$(keyVaultArmSvcConnectionName)"
      keyVaultName: "$(keyVaultName)"
      runLayerTest: "false"

  - template: ./template.terraform.previewdeploy.yml
    parameters:
      goVersion: "$(goVersion)"
      terraformVersion: "$(terraformVersion)"
      keyVaultArmSvcConnectionName: "$(keyVaultArmSvcConnectionName)"
      keyVaultName: "$(keyVaultName)"

  - template: ./template.terraform.test.yml
    parameters:
      goVersion: "$(goVersion)"
      terraformVersion: "$(terraformVersion)"
      keyVaultArmSvcConnectionName: "$(keyVaultArmSvcConnectionName)"
      keyVaultName: "$(keyVaultName)"

  - template: ./template.terraform.report.yml
    parameters:
      keyVaultArmSvcConnectionName: "$(keyVaultArmSvcConnectionName)"
      keyVaultName: "$(keyVaultName)"
