parameters:
  - name: goVersion
    type: string
    default: "1.18.1"
  - name: terraformVersion
    type: string
    default: "1.1.7"
  - name: envKVSVCName
    type: string
  - name: envKVName
    type: string

jobs:
  - job: previewDeploy
    workspace:
      clean: resources
    displayName: "Preivew & Deploy"
    dependsOn: validate

    steps:
      - checkout: self

      - task: Bash@3
        displayName: "Install Terraform"
        inputs:
          filePath: "orchestrators/scripts/setup-terraform.sh"
          workingDirectory: "$(System.DefaultWorkingDirectory)/orchestrators/scripts"
          arguments: ${{ parameters.terraformVersion }}
          bashEnvValue: "~/.profile"
          failOnStderr: true

      - task: GoTool@0
        inputs:
          version: ${{ parameters.goVersion }}
          goBin: "$(System.DefaultWorkingDirectory)"

      - script: echo '##vso[task.prependpath]$(System.DefaultWorkingDirectory)'

      - task: AzureKeyVault@2
        displayName: "Pull env cred from Azure Key valut"
        inputs:
          azureSubscription: ${{ parameters.envKVSVCName }}
          KeyVaultName: ${{ parameters.envKVName }}
          SecretsFilter: "*"
          RunAsPreJob: true

      - task: Bash@3
        displayName: "Run Terraform plan & Apply"
        env:
          WORKSPACE_PATH: $(System.DefaultWorkingDirectory)
          SUBID: $(SUBID)
          TENANTID: $(TENANTID)
          CLIENTID: $(CLIENTID)
          CLIENTSECRET: $(CLIENTSECRET)
          STATESTORAGEACCOUNT: $(STATESTORAGEACCOUNT)
          STATECONTAINER: $(STATECONTAINER)
          STATERG: $(STATERG)
          ENV: $(env)
        inputs:
          workingDirectory: "$(System.DefaultWorkingDirectory)/orchestrators/scripts"
          targetType: "inline"
          script: |
            chmod +x . ./iac.tf.previewdeploy.sh
            ./iac.tf.previewdeploy.sh
