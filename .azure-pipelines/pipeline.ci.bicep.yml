name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)

trigger:
  - none

pr:
  - none

variables:
  - name: agentImage
    value: "ubuntu-latest"

parameters:
  - name: environmentName
    default: "dev"

  - name: locationName
    default: "westus"

  - name: keyVaultArmSvcConnectionName
    default: "Symphony-KV"

  - name: keyVaultName
    default: "kv-symphony-env"

  - name: excludedFolders
    default: ","

pool:
  vmImage: $(agentImage)

stages:
  - stage: CI_Pipeline
    variables:
      group: ${{parameters.environmentName}}
    jobs:
      - job: xyz
        steps:
        - task: Bash@3
          displayName: "test variable group"
          inputs:
            failOnStderr: true
            targetType: "inline"
            script: |
              echo "variablegroup1: $(variablegroup1)"

      - template: ./template.bicep.validate.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}

      - template: ./template.bicep.previewdeploy.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}

      - template: ./template.bicep.test.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}
