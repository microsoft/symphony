name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)

trigger:
  - none

pr:
  - none

parameters:
  - name: agentImage
    defaultValue: "ubuntu-latest"

  - name: environmentName
    defaultValue: "dev"

  - name: locationName
    defaultValue: "westus"

  - name: keyVaultArmSvcConnectionName
    defaultValue: "Symphony-KV"

  - name: keyVaultName
    defaultValue: "kv-symphony-env"

  - name: excludedFolders
    defaultValue: ","

pool:
  vmImage: $(agentImage)

stages:
  - stage: CI_Pipeline
    variables:
      group: ${{parameters.environmentName}}
    jobs:
      - job: xyz
        steps:
        - task: Bash@3
          displayName: "test variable group"
          inputs:
            failOnStderr: true
            targetType: "inline"
            script: |
              echo "variablegroup1: ${variablegroup1}"

      - template: ./template.bicep.validate.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}

      - template: ./template.bicep.previewdeploy.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}

      - template: ./template.bicep.test.yml
        parameters:
          environmentName: ${{parameters.environmentName}}
          locationName: ${{parameters.locationName}}
          keyVaultArmSvcConnectionName: ${{parameters.keyVaultArmSvcConnectionName}}
          keyVaultName: ${{parameters.keyVaultName}}
          excludedFolders: ${{parameters.excludedFolders}}
