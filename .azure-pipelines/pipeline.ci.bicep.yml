name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)

trigger:
  - none

pr:
  - none

variables:
  #=============================================================#
  # The following Variables should be set on the pipeline level #
  #=============================================================#

  - name: agentImage
    value: "ubuntu-latest"

  - name: environmentName
    value: "dev"

  - name: locationName
    value: "westus"

  - name: keyVaultArmSvcConnectionName
    value: "Symphony-KV"

  - name: keyVaultName
    value: "kv-symphony-env"

  - name: excludedFolders
    value: ","

pool:
  vmImage: $(agentImage)

stages:
  - stage: CI Pipeline
    variables:
      group: ${{variables.environmentName}}
    jobs:
      - job: xyz
        steps:
        - task: Bash@3
          displayName: "test variable group"
          inputs:
            failOnStderr: true
            targetType: "inline"
            script: |
              echo "environmentName: $(environmentName)"
              echo "variablegroup1: $(variablegroup1)"

      - template: ./template.bicep.validate.yml
        parameters:
          environmentName: $(environmentName)
          locationName: $(locationName)
          keyVaultArmSvcConnectionName: $(keyVaultArmSvcConnectionName)
          keyVaultName: $(keyVaultName)
          excludedFolders: $(excludedFolders)

      - template: ./template.bicep.previewdeploy.yml
        parameters:
          environmentName: $(environmentName)
          locationName: $(locationName)
          keyVaultArmSvcConnectionName: $(keyVaultArmSvcConnectionName)
          keyVaultName: $(keyVaultName)
          excludedFolders: $(excludedFolders)

      - template: ./template.bicep.test.yml
        parameters:
          environmentName: $(environmentName)
          locationName: $(locationName)
          keyVaultArmSvcConnectionName: $(keyVaultArmSvcConnectionName)
          keyVaultName: $(keyVaultName)
          excludedFolders: $(excludedFolders)
