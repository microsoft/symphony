resources:
  repositories:
  - repository: Symphony
    type: github
    endpoint: Symphony2
    name: microsoft/symphony
    ref: main

name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)

trigger:
  - none

pr:
  - none

pool:
  vmImage: "ubuntu-latest"

variables:
  - name: workDir
    value: "$(System.DefaultWorkingDirectory)/IAC/Terraform//terraform"
  - name: runModuleTest
    value: true
  - name: runBackupState
    value: true


#============================================================
# The following Variables Should Be Set On the Pipeline
#============================================================
  - name: EnvironmentName
    value: "dev"
  - name : KeyVaultAzureSubscriptionName
    value: "Symphony-kv2"
  - name : KeyVaultName
    value: "kv-symphony-env"
  - name: GoVersion
    value: "1.18.1"
  - name: TerraformVersion
    value: "1.1.7"
  
stages:
 - stage: Validate
   displayName: "Validate Configuration"
   jobs:
     - template: ./ci_terraform_validate.yml
       parameters:
          goVersion : "$(GoVersion)"
          terraformVersion: "$(TerraformVersion)"
          envKVSVCName: "$(KeyVaultAzureSubscriptionName)"
          envKVName: "$(KeyVaultName)"

     - template: ./ci_terraform_previewdeploy.yml
       parameters:
          goVersion : "$(GoVersion)"
          terraformVersion: "$(TerraformVersion)"
          envKVSVCName: "$(KeyVaultAzureSubscriptionName)"
          envKVName: "$(KeyVaultName)"

     - template: ./ci_terraform_test.yml
       parameters:
          goVersion : "$(GoVersion)"
          terraformVersion: "$(TerraformVersion)"
          envKVSVCName: "$(KeyVaultAzureSubscriptionName)"
          envKVName: "$(KeyVaultName)"

     - template: ./ci_terraform_report.yml
       parameters:
          envKVSVCName: "$(KeyVaultAzureSubscriptionName)"
          envKVName: "$(KeyVaultName)"
